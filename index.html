<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compresor y Conversor de Imágenes Profesional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .drag-area {
            border: 3px dashed #4a5568;
        }
        .drag-area.active {
            border-color: #3b82f6;
            background-color: #2d3748;
        }
        input[type="range"] {
            -webkit-appearance: none; appearance: none;
            width: 100%; height: 8px;
            background: #4a5568; border-radius: 5px;
            outline: none; transition: opacity .2s;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 20px; height: 20px;
            background: #3b82f6; cursor: pointer;
            border-radius: 50%; box-shadow: 0 0 5px rgba(59, 130, 246, 0.7);
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px; height: 20px;
            background: #3b82f6; cursor: pointer;
            border-radius: 50%; border: none;
            box-shadow: 0 0 5px rgba(59, 130, 246, 0.7);
        }
        .loader {
            border-top-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-5xl mx-auto">
        <!-- Título y Descripción -->
        <div class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold mb-2 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-teal-400">Conversor y Compresor de Imágenes</h1>
            <p class="text-gray-400 text-lg">Una herramienta profesional para optimizar JPG, PNG, WEBP, GIF, BMP, TIFF y SVG.</p>
        </div>

        <!-- Pantalla de Carga de Archivos -->
        <div id="uploadScreen">
            <div id="dragArea" class="drag-area w-full p-10 text-center rounded-xl cursor-pointer transition-all duration-300 hover:bg-gray-800">
                <i class="fas fa-images text-5xl text-gray-500 mb-4"></i>
                <h2 class="text-2xl font-semibold mb-2">Arrastra y suelta tus imágenes aquí</h2>
                <p class="text-gray-500">o</p>
                <button id="browseBtn" class="mt-4 bg-blue-600 hover:bg-blue-700 rounded-lg px-6 py-2 font-semibold transition duration-300">
                    Seleccionar archivos
                </button>
                <input type="file" id="fileInput" class="hidden" accept="image/jpeg, image/png, image/webp, image/gif, image/bmp, image/tiff, image/svg+xml" multiple>
            </div>
            <p id="uploadError" class="text-red-500 text-center mt-4 hidden">Error: Por favor, sube un formato de imagen válido.</p>
        </div>

        <!-- Pantalla de Resultados -->
        <div id="resultScreen" class="hidden">
            <div id="processingIndicator" class="text-center my-8 hidden">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mx-auto"></div>
                <p class="mt-2 text-gray-400">Procesando imágenes...</p>
            </div>
            
            <!-- Controles Globales -->
            <div id="globalControls" class="bg-gray-800 p-4 rounded-lg border border-gray-700 mb-6 hidden">
                <h3 class="text-lg font-semibold mb-3 text-center">Controles Globales (para JPG/WEBP)</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div>
                        <label for="globalFormat" class="block text-sm font-medium text-gray-400 mb-1">Convertir todo a</label>
                        <select id="globalFormat" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <option value="image/jpeg">JPG</option>
                            <option value="image/png">PNG</option>
                            <option value="image/webp">WEBP</option>
                        </select>
                    </div>
                    <div>
                        <label for="globalQuality" class="block text-sm font-medium text-gray-400 mb-1">Calidad Global: <span id="globalQualityValue">0.75</span></label>
                        <input type="range" id="globalQuality" class="w-full" min="0.01" max="0.75" step="0.01" value="0.75">
                    </div>
                    <button id="applyGlobalBtn" title="Aplicar esta configuración a todas las imágenes" class="bg-blue-600 hover:bg-blue-700 h-10 rounded-lg font-semibold transition duration-300 flex items-center justify-center">
                        Aplicar a Todo
                    </button>
                </div>
            </div>

            <!-- Lista de Imágenes -->
            <div id="imageList" class="space-y-4 mb-8"></div>

            <!-- Resumen y Acciones -->
            <div class="bg-gray-800 p-6 rounded-lg border border-gray-700 sticky bottom-4 shadow-2xl">
                <div class="flex flex-col md:flex-row items-center justify-between text-center md:text-left">
                    <div>
                        <p class="text-lg">Total de Imágenes: <span id="totalImages" class="font-bold text-white">0</span></p>
                        <p class="text-gray-400">Tamaño Original: <span id="totalOriginalSize" class="font-semibold text-white">0 KB</span></p>
                    </div>
                    <div class="my-4 md:my-0">
                         <p class="text-lg text-green-400">Reducción Total</p>
                         <p id="totalReduction" class="text-3xl font-bold text-green-400">0%</p>
                    </div>
                    <div>
                        <p class="text-lg">Nuevo Tamaño: <span id="totalCompressedSize" class="font-bold text-white">0 KB</span></p>
                    </div>
                </div>
                <hr class="border-gray-700 my-6">
                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="downloadBtn" class="flex-1 text-center bg-green-600 hover:bg-green-700 rounded-lg px-8 py-3 font-semibold transition duration-300 flex items-center justify-center gap-2 disabled:bg-gray-500 disabled:cursor-not-allowed">
                        <i class="fas fa-download"></i>
                        <span>Descargar</span>
                    </button>
                    <button id="startOverBtn" class="flex-1 bg-gray-600 hover:bg-gray-500 rounded-lg px-8 py-3 font-semibold transition duration-300 flex items-center justify-center gap-2">
                        <i class="fas fa-sync-alt"></i>
                        <span>Empezar de Nuevo</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Plantilla para tarjeta de imagen -->
    <template id="imageCardTemplate">
        <div class="card-container bg-gray-800 p-4 rounded-lg border border-gray-700 relative">
            <button class="remove-btn absolute top-2 right-2 text-gray-500 hover:text-white transition-colors z-10" title="Eliminar imagen">
                 <i class="fas fa-times-circle fa-lg"></i>
            </button>
            <div class="flex flex-col sm:flex-row items-center gap-4 mb-4">
                <img class="thumbnail w-20 h-20 object-contain rounded-md bg-gray-700" src="https://placehold.co/80x80/2d3748/a0aec0?text=IMG" alt="miniatura">
                <div class="flex-grow w-full">
                    <p class="filename font-semibold truncate text-center sm:text-left">nombre_de_archivo.jpg</p>
                    <div class="flex flex-wrap text-sm text-gray-400 gap-x-4 mt-1 justify-center sm:justify-start">
                        <span>Original: <span class="original-size font-medium text-white">0 KB</span></span>
                        <span>Comprimido: <span class="compressed-size font-medium text-white">0 KB</span></span>
                        <span class="reduction-percentage-wrapper">Ahorro: <span class="reduction-percentage font-bold text-green-400">0%</span></span>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 border-t border-gray-700 pt-4">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Formato de Salida</label>
                    <select class="format-select w-full bg-gray-700 border border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        <option value="image/jpeg">JPG</option>
                        <option value="image/png">PNG</option>
                        <option value="image/webp">WEBP</option>
                    </select>
                </div>
                <div class="quality-control-container">
                    <label class="block text-sm font-medium text-gray-400 mb-1">Calidad: <span class="quality-value">0.75</span></label>
                    <input type="range" class="quality-slider w-full" min="0.01" max="0.75" step="0.01" value="0.75">
                </div>
            </div>
        </div>
    </template>

    <script>
        // DOM Elements
        const uploadScreen = document.getElementById('uploadScreen');
        const resultScreen = document.getElementById('resultScreen');
        const dragArea = document.getElementById('dragArea');
        const browseBtn = document.getElementById('browseBtn');
        const fileInput = document.getElementById('fileInput');
        const uploadError = document.getElementById('uploadError');
        const processingIndicator = document.getElementById('processingIndicator');
        const imageList = document.getElementById('imageList');
        const imageCardTemplate = document.getElementById('imageCardTemplate');
        
        // Global controls
        const globalControls = document.getElementById('globalControls');
        const globalFormatSelect = document.getElementById('globalFormat');
        const globalQualitySlider = document.getElementById('globalQuality');
        const globalQualityValue = document.getElementById('globalQualityValue');
        const applyGlobalBtn = document.getElementById('applyGlobalBtn');

        // Summary elements & Action buttons
        const totalImages = document.getElementById('totalImages');
        const totalOriginalSize = document.getElementById('totalOriginalSize');
        const totalCompressedSize = document.getElementById('totalCompressedSize');
        const totalReduction = document.getElementById('totalReduction');
        const downloadBtn = document.getElementById('downloadBtn');
        const startOverBtn = document.getElementById('startOverBtn');
        
        // In-memory store and constants
        let imageStore = [];
        const VALID_MIMETYPES = ['image/jpeg', 'image/png', 'image/webp', 'image/gif', 'image/bmp', 'image/tiff', 'image/svg+xml'];
        const INITIAL_QUALITY = 0.75;

        // --- Event Listeners ---
        dragArea.addEventListener('dragover', (e) => { e.preventDefault(); dragArea.classList.add('active'); });
        dragArea.addEventListener('dragleave', () => dragArea.classList.remove('active'));
        dragArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dragArea.classList.remove('active');
            handleFiles(e.dataTransfer.files);
        });
        browseBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
        startOverBtn.addEventListener('click', resetApp);
        downloadBtn.addEventListener('click', handleDownload);
        applyGlobalBtn.addEventListener('click', applyGlobalSettings);
        globalQualitySlider.addEventListener('input', () => { globalQualityValue.textContent = globalQualitySlider.value; });

        // --- Core Functions ---
        async function handleFiles(files) {
            const validFiles = Array.from(files).filter(f => VALID_MIMETYPES.includes(f.type));
            if (validFiles.length === 0 && files.length > 0) {
                uploadError.style.display = 'block';
                return;
            }
            uploadError.style.display = 'none';
            if (validFiles.length === 0) return;

            if (imageStore.length === 0) {
                uploadScreen.style.display = 'none';
                resultScreen.style.display = 'block';
            }
            
            processingIndicator.style.display = 'block';
            downloadBtn.disabled = true;

            const newFilesPromises = validFiles.map(file => {
                const id = `img_${Date.now()}_${Math.random()}`;
                const card = createCard(id, file);
                imageList.appendChild(card);
                
                const imageData = { id, card, originalFile: file, outputType: getInitialOutputType(file), quality: INITIAL_QUALITY, compressedBlob: null, thumbnailSrc: null };
                
                imageStore.push(imageData);
                return recompressImage(id);
            });
            
            await Promise.all(newFilesPromises);
            processingIndicator.style.display = 'none';
            downloadBtn.disabled = false;
        }

        function createCard(id, file) {
            const card = imageCardTemplate.content.cloneNode(true).querySelector('.card-container');
            card.dataset.id = id;
            card.querySelector('.filename').textContent = file.name;
            
            const formatSelect = card.querySelector('.format-select');
            const qualityControl = card.querySelector('.quality-control-container');
            const qualitySlider = card.querySelector('.quality-slider');
            const qualityValue = card.querySelector('.quality-value');

            qualitySlider.value = INITIAL_QUALITY;
            qualitySlider.max = INITIAL_QUALITY;
            qualityValue.textContent = INITIAL_QUALITY;

            if (file.type === 'image/svg+xml') {
                formatSelect.innerHTML = `<option value="image/svg+xml">SVG</option>`;
                formatSelect.disabled = true;
                qualityControl.style.display = 'none';
            } else {
                formatSelect.value = getInitialOutputType(file);
                toggleQualitySlider(card, formatSelect.value);
            }

            formatSelect.addEventListener('change', (e) => {
                const image = imageStore.find(img => img.id === id);
                image.outputType = e.target.value;
                toggleQualitySlider(card, image.outputType);
                recompressImage(id);
            });
            
            qualitySlider.addEventListener('input', (e) => { qualityValue.textContent = e.target.value; });
            qualitySlider.addEventListener('change', (e) => {
                const image = imageStore.find(img => img.id === id);
                image.quality = parseFloat(e.target.value);
                recompressImage(id);
            });

            card.querySelector('.remove-btn').addEventListener('click', () => removeImage(id));
            
            return card;
        }
        
        function recompressImage(id) {
            return new Promise(async (resolve) => {
                const image = imageStore.find(img => img.id === id);
                if (!image) return resolve();

                const { originalFile, outputType, quality } = image;
                
                if (originalFile.type === 'image/svg+xml') {
                    const svgText = await readFileAsText(originalFile);
                    let minifiedSvg = svgText.replace(/<!--[\s\S]*?-->/g, "").replace(/>\s{1,}</g, "><").replace(/\s{2,}/g, " ").trim();
                    image.compressedBlob = new Blob([minifiedSvg], { type: 'image/svg+xml' });
                    image.thumbnailSrc = `data:image/svg+xml;base64,${btoa(svgText)}`;
                } else {
                    const dataUrl = image.thumbnailSrc || await readFileAsDataURL(originalFile);
                    if (!image.thumbnailSrc) image.thumbnailSrc = dataUrl;
                    
                    const img = await loadImage(dataUrl);
                    const canvas = document.createElement('canvas');
                    canvas.width = img.naturalWidth;
                    canvas.height = img.naturalHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);

                    const compressedDataUrl = canvas.toDataURL(outputType, ['image/jpeg', 'image/webp'].includes(outputType) ? quality : undefined);
                    const compressedBlob = dataURLtoBlob(compressedDataUrl);
                    
                    if (outputType === 'image/png' && compressedBlob.size > originalFile.size) {
                        image.compressedBlob = originalFile;
                    } else {
                        image.compressedBlob = compressedBlob;
                    }
                }
                
                updateCardUI(image);
                updateTotalSummary();
                resolve();
            });
        }
        
        async function applyGlobalSettings() {
            const globalFormat = globalFormatSelect.value;
            const globalQuality = parseFloat(globalQualitySlider.value);

            processingIndicator.style.display = 'block';
            downloadBtn.disabled = true;

            const recompressPromises = imageStore.map(image => {
                if (image.originalFile.type !== 'image/svg+xml') {
                    image.outputType = globalFormat;
                    image.quality = globalQuality;
                    
                    image.card.querySelector('.format-select').value = globalFormat;
                    const qualitySlider = image.card.querySelector('.quality-slider');
                    qualitySlider.value = globalQuality;
                    qualitySlider.max = globalQuality;
                    image.card.querySelector('.quality-value').textContent = globalQuality;
                    toggleQualitySlider(image.card, globalFormat);
                    
                    return recompressImage(image.id);
                }
                return Promise.resolve();
            });
            
            await Promise.all(recompressPromises);
            processingIndicator.style.display = 'none';
            downloadBtn.disabled = false;
        }

        function removeImage(id) {
            const index = imageStore.findIndex(img => img.id === id);
            if (index > -1) {
                imageStore[index].card.remove();
                imageStore.splice(index, 1);
                updateTotalSummary();
                if (imageStore.length === 0) {
                    resetApp();
                }
            }
        }

        function resetApp() {
            imageStore = [];
            fileInput.value = '';
            resultScreen.style.display = 'none';
            uploadScreen.style.display = 'block';
            imageList.innerHTML = '';
            updateTotalSummary();
        }

        // --- UI Update & Helper Functions ---
        function updateCardUI(image) {
            const { card, originalFile, compressedBlob, thumbnailSrc } = image;
            if (!card || !compressedBlob) return;

            card.querySelector('.thumbnail').src = thumbnailSrc;
            card.querySelector('.original-size').textContent = formatBytes(originalFile.size);
            const compressedSize = compressedBlob.size;
            card.querySelector('.compressed-size').textContent = formatBytes(compressedSize);
            
            let reduction = 0;
            if (compressedSize < originalFile.size) {
                reduction = 100 - (compressedSize / originalFile.size * 100);
            }
            const reductionSpan = card.querySelector('.reduction-percentage');
            reductionSpan.textContent = `${reduction.toFixed(1)}%`;
            reductionSpan.classList.toggle('text-green-400', reduction > 0);
            reductionSpan.classList.toggle('text-yellow-400', reduction <= 0);
        }

        function updateTotalSummary() {
            let totalOriginal = 0, totalCompressed = 0;
            let hasRasterImages = false;
            imageStore.forEach(img => {
                totalOriginal += img.originalFile.size;
                if (img.compressedBlob) totalCompressed += img.compressedBlob.size;
                if(img.originalFile.type !== 'image/svg+xml') hasRasterImages = true;
            });

            totalImages.textContent = imageStore.length;
            totalOriginalSize.textContent = formatBytes(totalOriginal);
            totalCompressedSize.textContent = formatBytes(totalCompressed);
            totalReduction.textContent = `${(totalOriginal > 0 ? 100 - (totalCompressed / totalOriginal * 100) : 0).toFixed(1)}%`;
            
            globalControls.style.display = hasRasterImages ? 'block' : 'none';

            const buttonSpan = downloadBtn.querySelector('span');
            const buttonIcon = downloadBtn.querySelector('i');
            if (imageStore.length === 1) {
                buttonSpan.textContent = 'Descargar Imagen';
                buttonIcon.className = 'fas fa-download';
            } else {
                buttonSpan.textContent = 'Descargar Todo (ZIP)';
                buttonIcon.className = 'fas fa-file-archive';
            }
        }

        function toggleQualitySlider(card, mimeType) {
            card.querySelector('.quality-control-container').style.display = mimeType === 'image/png' ? 'none' : 'block';
        }

        function getInitialOutputType(file) {
            const selectableOutputs = ['image/jpeg', 'image/png', 'image/webp', 'image/svg+xml'];
            if (selectableOutputs.includes(file.type)) {
                return file.type;
            }
            return 'image/png'; // Default for GIF, BMP, TIFF
        }
        
        function handleDownload() {
            if (imageStore.length === 0 || !imageStore.every(img => img.compressedBlob)) return;

            if (imageStore.length === 1) {
                const image = imageStore[0];
                const extension = image.compressedBlob.type.split('/')[1].replace('+xml', 'svg');
                const originalName = image.originalFile.name.split('.').slice(0, -1).join('.');
                const link = document.createElement('a');
                link.href = URL.createObjectURL(image.compressedBlob);
                link.download = `${originalName}-comprimido.${extension}`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            } else {
                const zip = new JSZip();
                imageStore.forEach(image => {
                    const extension = image.compressedBlob.type.split('/')[1].replace('+xml', 'svg');
                    const originalName = image.originalFile.name.split('.').slice(0, -1).join('.');
                    zip.file(`${originalName}-comprimido.${extension}`, image.compressedBlob);
                });
                
                zip.generateAsync({type:"blob"}).then(function(content) {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = `imagenes-comprimidas-${Date.now()}.zip`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                });
            }
        }

        // --- File & Data Helpers ---
        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        function readFileAsText(file) {
             return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }
        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = src;
            });
        }
        function formatBytes(bytes, d = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024, sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes/Math.pow(k,i)).toFixed(d<0?0:d))} ${sizes[i]}`;
        }
        function dataURLtoBlob(dataurl) {
            const arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
            bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while (n--) u8arr[n] = bstr.charCodeAt(n);
            return new Blob([u8arr], {type: mime});
        }
    </script>
</body>
</html>
